<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="style/dashboard.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      .dashboard-tables-flex {
        display: flex;
        gap: 36px;
        margin-bottom: 22px;
      }
      .data-table-section {
        flex: 2;
        min-width: 260px;
      }
      .side-approve-tables {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 22px;
      }
      .approve-table-wrap {
        background: #f8fafc;
        border-radius: 12px;
        padding: 13px 12px 18px 12px;
        box-shadow: 0 2px 12px rgba(86, 67, 255, 0.06);
        margin-bottom: 14px;
      }
      .approve-title {
        font-size: 1.07em;
        font-weight: 600;
        margin-bottom: 7px;
        margin-left: 2px;
      }
      .approve-title.green {
        color: #16c784;
      }
      .approve-title.red {
        color: #ef4444;
      }
      .small-table {
        width: 100%;
        font-size: 0.99em;
        border-collapse: collapse;
        background: transparent;
      }
      .small-table th,
      .small-table td {
        border-bottom: 1px solid #e8e8e8;
        padding: 5px 7px;
        text-align: left;
      }
      .small-table th {
        font-weight: 600;
        color: #444;
        background: transparent;
      }
      .small-table tr:last-child td {
        border-bottom: none;
      }
      /* Responsive */
      @media (max-width: 900px) {
        .dashboard-tables-flex {
          flex-direction: column;
          gap: 18px;
        }
        .side-approve-tables {
          flex-direction: row;
          gap: 12px;
        }
        .approve-table-wrap {
          flex: 1;
          min-width: 110px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <img
            src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgRf2hY0A5B5EzP-Exi-cp002izlyCCtWYX9R8PTBmtDkm_0UGnCCMCRgicd6voh2p7aQ0NNiRAX2M4YvUxTcT-CVTENoU8xp39x1mcDCoc1YbuI9xY6iZEMoIQlvS2gPWE7CJCvwxQKR8/s320/telkom-akses.png"
            alt="Logo"
            class="logo-icon"
            style="
              height: 50px;
              max-width: 250px;
              object-fit: contain;
              margin-right: 9px;
              vertical-align: middle;
            "
          />
        </div>
        <nav>
          <a href="#" class="active">Dashboard</a>
          <a href="folder.html">Folder Lokasi</a>
          <a href="folder_approve.html">Folder Approve</a>
          <a href="#" onclick="logout()">Logout</a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main>
        <!-- Header Bar -->
        <header class="topbar">
          <h2>Dashboard</h2>
          <div class="user-profile" id="userProfileBtn" tabindex="0">
            ðŸ‘¤ Admin â–¾
          </div>
        </header>

        <!-- Card Stats -->
        <section class="overview-cards">
          <div class="card blue">
            <div class="card-title">Total Lokasi</div>
            <div class="card-value" id="total_lokasi">0</div>
          </div>
          <div class="card green">
            <div class="card-title">Sudah Lengkap</div>
            <div class="card-value" id="lokasi_completed">0</div>
          </div>
          <div class="card orange">
            <div class="card-title">Belum Lengkap</div>
            <div class="card-value" id="lokasi_belum">0</div>
          </div>
        </section>

        <section class="overview-cards">
          <div class="card blue">
            <div class="card-title">Total Approve</div>
            <div class="card-value" id="lokasi_approved">0</div>
          </div>
          <div class="card red">
            <div class="card-title">Belum Approve</div>
            <div class="card-value" id="lokasi_belum_approve">0</div>
          </div>
        </section>

        <!-- Table & Approve Tables -->
        <section class="dashboard-tables-flex">
          <!-- KIRI: Tabel Daftar Lokasi -->
          <div class="data-table-section" style="flex: 2">
            <h3>Daftar Lokasi</h3>
            <div class="dashboard-searchbar">
              <input
                type="text"
                id="searchLokasi"
                placeholder="Cari Nama Lokasi..."
                autocomplete="off"
              />
              <select id="filterStatus" class="dashboard-filter-status">
                <option value="">Semua Status</option>
                <option value="lengkap">Lengkap</option>
                <option value="belum">Belum Lengkap</option>
              </select>
            </div>

            <table class="data-table">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Nama Lokasi</th>
                  <th onclick="sortStatus()" style="cursor: pointer">
                    Status &#x25B2;&#x25BC;
                  </th>
                </tr>
              </thead>
              <tbody id="dataLokasi"></tbody>
            </table>
          </div>

          <!-- KANAN: Sudah Approve & Belum Approve -->
          <div class="side-approve-tables" style="flex: 1">
            <div class="approve-table-wrap">
              <h4 class="approve-title green">Sudah Approve</h4>
              <table class="small-table">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Lokasi</th>
                  </tr>
                </thead>
                <tbody id="approvedList"></tbody>
              </table>
            </div>
            <div class="approve-table-wrap">
              <h4 class="approve-title red">Belum Approve</h4>
              <table class="small-table">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Lokasi</th>
                  </tr>
                </thead>
                <tbody id="notApprovedList"></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal Profile & Password -->
    <div id="profileModal" class="modal-profile" style="display: none">
      <div class="modal-content">
        <span class="close-modal" onclick="closeProfileModal()">&times;</span>
        <h3>Profil Akun</h3>
        <form id="formProfile" autocomplete="off">
          <label>Nama:</label>
          <input type="text" id="profileNama" required />
          <label>Username:</label>
          <input type="text" id="profileUsername" required readonly />
          <label>Jabatan:</label>
          <input type="text" id="profileJabatan" required />
          <label>Email:</label>
          <input type="email" id="profileEmail" required />
          <button type="submit">Simpan Perubahan</button>
        </form>
        <div id="profileMsg"></div>
        <hr />
        <h3>Ganti Password</h3>
        <form id="formChangePass" autocomplete="off">
          <label>Password Lama:</label>
          <input
            type="password"
            id="oldPass"
            required
            autocomplete="current-password"
          />
          <label>Password Baru:</label>
          <input
            type="password"
            id="newPass"
            required
            minlength="6"
            autocomplete="new-password"
          />
          <button type="submit">Ubah Password</button>
        </form>
        <div id="changePassMsg"></div>
      </div>
    </div>

    <script>
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        window.location = "login.html";
      }

      const token = localStorage.getItem("token");
      const userRole = localStorage.getItem("role") || "";
      if (!token) window.location = "login.html";

      // Nama user global
      let namaAkun = "Admin";
      let allLokasi = [];

      // --- Nama User Dinamis di Header ---
      async function setUserNameOnHeader() {
        try {
          let endpoint =
            userRole === "tif"
              ? "https://be-telkom-access.vercel.app/tif_accounts/me"
              : "https://be-telkom-access.vercel.app/account/me";
          const res = await fetch(endpoint, {
            headers: { Authorization: "Bearer " + token },
          });
          const data = await res.json();
          if (data.nama) {
            namaAkun = data.nama;
            document.getElementById(
              "userProfileBtn"
            ).innerHTML = `ðŸ‘¤ ${namaAkun} â–¾`;
          }
        } catch (err) {
          document.getElementById("userProfileBtn").innerHTML = `ðŸ‘¤ Admin â–¾`;
        }
      }
      setUserNameOnHeader();

      // Fetch data lokasi & update dashboard stat
      async function loadLokasiDashboard() {
        const res = await fetch(
          "https://be-telkom-access.vercel.app/locations",
          {
            headers: { Authorization: "Bearer " + token },
          }
        );
        const data = await res.json();
        allLokasi = Array.isArray(data) ? data : [];
        updateStatCards(allLokasi);
        renderLokasi();
      }

      // Update stat cards (Total, Lengkap, Belum Lengkap, Approve)
      function updateStatCards(lokasiList) {
        let total = lokasiList.length;
        let lengkap = 0;
        let belum = 0;
        let approved = 0;
        let belumApprove = 0;

        lokasiList.forEach((lokasi) => {
          let isCompleted =
            lokasi.location_status &&
            lokasi.location_status.length > 0 &&
            (lokasi.location_status[0].status === "completed" ||
              lokasi.location_status[0].status === "lengkap");
          if (isCompleted) lengkap++;
          else belum++;

          // Cek status approve
          if (lokasi.approved_tif === true) {
            approved++;
          } else {
            belumApprove++;
          }
        });

        document.getElementById("total_lokasi").innerText = total;
        document.getElementById("lokasi_completed").innerText = lengkap;
        document.getElementById("lokasi_belum").innerText = belum;
        document.getElementById("lokasi_approved").innerText = approved;
        document.getElementById("lokasi_belum_approve").innerText =
          belumApprove;
      }

      // Sorting Status
      let sortStatusAsc = true;

      function sortStatus() {
        let filter = document
          .getElementById("searchLokasi")
          .value.trim()
          .toLowerCase();
        let filterStatus = document.getElementById("filterStatus").value;
        let filtered =
          filter.length > 0
            ? allLokasi.filter((l) =>
                l.nama_lokasi.toLowerCase().includes(filter)
              )
            : [...allLokasi];
        if (filterStatus === "lengkap" || filterStatus === "belum") {
          filtered = filtered.filter((lokasi) => {
            let isCompleted =
              lokasi.location_status &&
              lokasi.location_status.length > 0 &&
              (lokasi.location_status[0].status === "completed" ||
                lokasi.location_status[0].status === "lengkap");
            return filterStatus === "lengkap" ? isCompleted : !isCompleted;
          });
        }
        filtered.sort((a, b) => {
          const aCompleted =
            a.location_status &&
            a.location_status.length > 0 &&
            (a.location_status[0].status === "completed" ||
              a.location_status[0].status === "lengkap");
          const bCompleted =
            b.location_status &&
            b.location_status.length > 0 &&
            (b.location_status[0].status === "completed" ||
              b.location_status[0].status === "lengkap");
          if (aCompleted === bCompleted) return 0;
          return sortStatusAsc ? (aCompleted ? -1 : 1) : aCompleted ? 1 : -1;
        });

        sortStatusAsc = !sortStatusAsc;
        renderLokasiTable(filtered);
        updateStatCards(filtered);
        renderApproveTables(filtered);
      }

      // Fungsi render khusus hasil sorting dan filter
      function renderLokasiTable(lokasiArr) {
        const tbody = document.getElementById("dataLokasi");
        let html = "";
        if (lokasiArr.length > 0) {
          lokasiArr.forEach((lokasi, i) => {
            let isCompleted =
              lokasi.location_status &&
              lokasi.location_status.length > 0 &&
              (lokasi.location_status[0].status === "completed" ||
                lokasi.location_status[0].status === "lengkap");
            let statusLabel = isCompleted ? "LENGKAP" : "BELUM LENGKAP";
            let statusClass = isCompleted ? "lengkap" : "belum";
            html += `<tr>
              <td>${i + 1}</td>
              <td>${lokasi.nama_lokasi}</td>
              <td><span class="badge status ${statusClass}">${statusLabel}</span></td>
            </tr>`;
          });
        } else {
          html = `<tr>
    <td colspan="4" style="text-align:center; color:#888888;">
      Tidak ada lokasi ditemukan
    </td>
  </tr>`;
        }

        tbody.innerHTML = html;
      }

      // Tabel Approve & Belum Approve (kanan)
      function renderApproveTables(lokasiList) {
        // Sudah Approve
        const approved = lokasiList.filter((l) => l.approved_tif === true);
        // Belum Approve
        const notApproved = lokasiList.filter((l) => l.approved_tif !== true);

        let approvedHTML = "";
        approved.forEach((l, i) => {
          approvedHTML += `<tr>
            <td>${i + 1}</td>
            <td>${l.nama_lokasi}</td>
          </tr>`;
        });
        document.getElementById("approvedList").innerHTML =
          approvedHTML || `<tr><td colspan="2" style="color:#aaa">-</td></tr>`;

        let notApprovedHTML = "";
        notApproved.forEach((l, i) => {
          notApprovedHTML += `<tr>
            <td>${i + 1}</td>
            <td>${l.nama_lokasi}</td>
          </tr>`;
        });
        document.getElementById("notApprovedList").innerHTML =
          notApprovedHTML ||
          `<tr><td colspan="2" style="color:#aaa">-</td></tr>`;
      }

      // Render lokasi (with filter)
      function renderLokasi(keyword = "") {
        const filter = (keyword || "").trim().toLowerCase();
        const filterStatus = document.getElementById("filterStatus").value;
        let filtered = allLokasi;
        if (filter.length > 0) {
          filtered = allLokasi.filter((l) =>
            l.nama_lokasi.toLowerCase().includes(filter)
          );
        }
        if (filterStatus === "lengkap" || filterStatus === "belum") {
          filtered = filtered.filter((lokasi) => {
            let isCompleted =
              lokasi.location_status &&
              lokasi.location_status.length > 0 &&
              (lokasi.location_status[0].status === "completed" ||
                lokasi.location_status[0].status === "lengkap");
            return filterStatus === "lengkap" ? isCompleted : !isCompleted;
          });
        }
        renderLokasiTable(filtered);
        updateStatCards(filtered);
        renderApproveTables(filtered);
      }

      // Event listener untuk filter status
      document
        .getElementById("filterStatus")
        .addEventListener("change", function () {
          renderLokasi(document.getElementById("searchLokasi").value);
        });

      // Search event (live filter + update card stats juga)
      document
        .getElementById("searchLokasi")
        .addEventListener("input", function () {
          renderLokasi(this.value);
        });

      loadLokasiDashboard();

      // ------------ PROFILE MODAL LOGIC -------------
      function openProfileModal() {
        document.getElementById("profileModal").style.display = "flex";
        fetchProfileData();
      }
      function closeProfileModal() {
        document.getElementById("profileModal").style.display = "none";
        document.getElementById("profileMsg").innerText = "";
        document.getElementById("changePassMsg").innerText = "";
        document.getElementById("formChangePass").reset();
      }
      document.getElementById("userProfileBtn").onclick = openProfileModal;

      // Fetch data akun (otomatis menyesuaikan role)
      async function fetchProfileData() {
        let endpoint =
          userRole === "tif"
            ? "https://be-telkom-access.vercel.app/tif_accounts/me"
            : "https://be-telkom-access.vercel.app/account/me";
        const res = await fetch(endpoint, {
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();
        document.getElementById("profileNama").value = data.nama || "";
        document.getElementById("profileUsername").value = data.username || "";
        document.getElementById("profileJabatan").value = data.jabatan || "";
        document.getElementById("profileEmail").value = data.email || "";
      }

      // Update profile
      document.getElementById("formProfile").onsubmit = async function (e) {
        e.preventDefault();
        const nama = document.getElementById("profileNama").value;
        const jabatan = document.getElementById("profileJabatan").value;
        const email = document.getElementById("profileEmail").value;
        let endpoint =
          userRole === "tif"
            ? "https://be-telkom-access.vercel.app/tif_accounts/me"
            : "https://be-telkom-access.vercel.app/account/me";
        const res = await fetch(endpoint, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ nama, jabatan, email }),
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById("profileMsg").style.color = "green";
          document.getElementById("profileMsg").innerText =
            "Data berhasil diperbarui.";
          document.getElementById("userProfileBtn").innerHTML = `ðŸ‘¤ ${nama} â–¾`;
        } else {
          document.getElementById("profileMsg").style.color = "red";
          document.getElementById("profileMsg").innerText =
            data.error || "Update gagal.";
        }
      };

      // ------------ GANTI PASSWORD LOGIC -------------
      document.getElementById("formChangePass").onsubmit = async function (e) {
        e.preventDefault();
        const old_password = document.getElementById("oldPass").value;
        const new_password = document.getElementById("newPass").value;
        const msgDiv = document.getElementById("changePassMsg");
        msgDiv.style.color = "#444";
        msgDiv.innerText = "Memproses...";

        let endpoint =
          userRole === "tif"
            ? "https://be-telkom-access.vercel.app/tif_accounts/change-password"
            : "https://be-telkom-access.vercel.app/account/change-password";
        const res = await fetch(endpoint, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ old_password, new_password }),
        });
        const data = await res.json();
        if (res.ok) {
          msgDiv.style.color = "green";
          msgDiv.innerText = "Password berhasil diubah!";
          document.getElementById("formChangePass").reset();
        } else {
          msgDiv.style.color = "red";
          msgDiv.innerText = data.error || "Gagal mengganti password.";
        }
      };

      window.onclick = function (event) {
        const modal = document.getElementById("profileModal");
        if (event.target === modal) {
          closeProfileModal();
        }
      };
    </script>
  </body>
</html>
